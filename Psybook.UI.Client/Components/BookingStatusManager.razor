@using Psybook.Objects.DbModels
@using Psybook.Objects.Enums
@using Psybook.Services.UI.DataLoaders
@using Microsoft.Extensions.Logging
@inject IBookingLoaderService BookingLoaderService
@inject ILogger<BookingStatusManager> Logger
@inject ISnackbar Snackbar

<MudCard>
    <MudCardContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6">Booking Status: @Booking.StatusDisplayName</MudText>
            
            <MudChip T="string" 
                     Color="@Booking.StatusColor" 
                     Size="Size.Small">
                @Booking.StatusDisplayName
            </MudChip>

            @if (Booking.Status == BookingStatus.Pending)
            {
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success" 
                               StartIcon="@Icons.Material.Filled.Check"
                               OnClick="ConfirmBooking"
                               Disabled="IsOperationInProgress">
                        @if (IsOperationInProgress && _currentOperation == "confirm")
                        {
                            <MudProgressCircular Color="Color.Success" Size="Size.Small" Indeterminate="true" />
                        }
                        else
                        {
                            <text>Confirm Booking</text>
                        }
                    </MudButton>
                    
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Error" 
                               StartIcon="@Icons.Material.Filled.Cancel"
                               OnClick="() => ShowCancelDialog = true"
                               Disabled="IsOperationInProgress">
                        Cancel Booking
                    </MudButton>
                </MudStack>
            }
            else if (Booking.Status == BookingStatus.Confirmed)
            {
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Error" 
                               StartIcon="@Icons.Material.Filled.Cancel"
                               OnClick="() => ShowCancelDialog = true"
                               Disabled="IsOperationInProgress">
                        Cancel Booking
                    </MudButton>
                    
                    @if (Booking.Start > DateTime.Now)
                    {
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Info" 
                                   StartIcon="@Icons.Material.Filled.CheckCircle"
                                   OnClick="MarkAsCompleted"
                                   Disabled="IsOperationInProgress">
                            @if (IsOperationInProgress && _currentOperation == "complete")
                            {
                                <MudProgressCircular Color="Color.Info" Size="Size.Small" Indeterminate="true" />
                            }
                            else
                            {
                                <text>Mark as Completed</text>
                            }
                        </MudButton>
                    }
                </MudStack>
            }

            @if (Booking.CancelledAt.HasValue)
            {
                <MudAlert Severity="Severity.Warning">
                    <MudText Typo="Typo.body2">
                        <strong>Cancelled:</strong> @Booking.CancelledAt.Value.ToString("MMM dd, yyyy 'at' HH:mm")
                    </MudText>
                    @if (!string.IsNullOrEmpty(Booking.CancellationReason))
                    {
                        <MudText Typo="Typo.body2">
                            <strong>Reason:</strong> @Booking.CancellationReason
                        </MudText>
                    }
                </MudAlert>
            }

            <MudStack Spacing="1">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Created: @Booking.CreatedAt.ToString("MMM dd, yyyy 'at' HH:mm")
                </MudText>
                
                @if (Booking.ModifiedAt.HasValue)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Last Modified: @Booking.ModifiedAt.Value.ToString("MMM dd, yyyy 'at' HH:mm")
                        @if (!string.IsNullOrEmpty(Booking.ModifiedBy))
                        {
                            <text> by @Booking.ModifiedBy</text>
                        }
                    </MudText>
                }
            </MudStack>
            
            @if (!string.IsNullOrEmpty(Booking.Notes))
            {
                <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Notes">
                    <MudText Typo="Typo.body2">
                        <strong>Notes:</strong> @Booking.Notes
                    </MudText>
                </MudAlert>
            }
        </MudStack>
    </MudCardContent>
</MudCard>

<!-- Cancel Booking Dialog -->
<MudDialog @bind-Visible="ShowCancelDialog" Options="DialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Cancel" Class="mr-3" />
            Cancel Booking
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudAlert Severity="Severity.Warning" Icon="@Icons.Material.Filled.Warning">
                Are you sure you want to cancel this booking? This action cannot be undone.
            </MudAlert>
            
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                <strong>Experience:</strong> @Booking.Title<br/>
                <strong>Date:</strong> @Booking.Start.ToString("dddd, MMMM dd, yyyy 'at' hh:mm tt")<br/>
                <strong>Customer:</strong> @($"{Booking.FirstName} {Booking.LastName}")
            </MudText>
            
            <MudTextField @bind-Value="CancellationReason"
                          Label="Cancellation Reason"
                          Placeholder="Please provide a reason for cancellation..."
                          Lines="3"
                          Variant="Variant.Outlined"
                          Required="true"
                          MaxLength="500"
                          Counter="500"
                          Error="@(!string.IsNullOrWhiteSpace(CancellationReason) && CancellationReason.Length > 500)"
                          ErrorText="Cancellation reason cannot exceed 500 characters"
                          HelperText="A clear reason helps with record keeping and customer communication" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => { ShowCancelDialog = false; CancellationReason = string.Empty; }"
                   Disabled="IsOperationInProgress">
            Close
        </MudButton>
        <MudButton Color="Color.Error" 
                   Variant="Variant.Filled" 
                   OnClick="CancelBooking"
                   Disabled="string.IsNullOrWhiteSpace(CancellationReason) || IsOperationInProgress || CancellationReason.Length > 500">
            @if (IsOperationInProgress && _currentOperation == "cancel")
            {
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudProgressCircular Color="Color.Error" Size="Size.Small" Indeterminate="true" />
                    <MudText>Cancelling...</MudText>
                </MudStack>
            }
            else
            {
                <text>Cancel Booking</text>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public CalendarSlot Booking { get; set; } = null!;
    [Parameter] public EventCallback<CalendarSlot> OnBookingUpdated { get; set; }
    [Parameter] public string? ModifiedBy { get; set; } = "System"; // You can inject user info here
    
    private bool ShowCancelDialog;
    private string CancellationReason = string.Empty;
    private bool IsOperationInProgress;
    private string _currentOperation = string.Empty;
    
    private DialogOptions DialogOptions => new()
    {
        MaxWidth = MaxWidth.Small,
        FullWidth = true,
        CloseButton = true,
        CloseOnEscapeKey = true
    };

    private async Task ConfirmBooking()
    {
        try
        {
            IsOperationInProgress = true;
            _currentOperation = "confirm";
            StateHasChanged();

            var success = await BookingLoaderService.ConfirmBookingAsync(Booking.Id, ModifiedBy);
            
            if (success)
            {
                // Update the local booking object
                Booking.Status = BookingStatus.Confirmed;
                Booking.ModifiedAt = DateTime.UtcNow;
                Booking.ModifiedBy = ModifiedBy;
                
                await OnBookingUpdated.InvokeAsync(Booking);
                Snackbar.Add($"Booking for {Booking.FirstName} {Booking.LastName} has been confirmed", Severity.Success);
                Logger.LogInformation("Booking {BookingId} confirmed successfully", Booking.Id);
            }
            else
            {
                Snackbar.Add("Failed to confirm booking. The booking may not be in a valid state for confirmation.", Severity.Error);
                Logger.LogWarning("Failed to confirm booking {BookingId} - service returned false", Booking.Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("An error occurred while confirming the booking. Please try again.", Severity.Error);
            Logger.LogError(ex, "Failed to confirm booking {BookingId}", Booking.Id);
        }
        finally
        {
            IsOperationInProgress = false;
            _currentOperation = string.Empty;
            StateHasChanged();
        }
    }

    private async Task CancelBooking()
    {
        try
        {
            IsOperationInProgress = true;
            _currentOperation = "cancel";
            StateHasChanged();

            var success = await BookingLoaderService.CancelBookingAsync(Booking.Id, CancellationReason, ModifiedBy);
            
            if (success)
            {
                // Update the local booking object
                Booking.Status = BookingStatus.Cancelled;
                Booking.CancellationReason = CancellationReason;
                Booking.CancelledAt = DateTime.UtcNow;
                Booking.ModifiedAt = DateTime.UtcNow;
                Booking.ModifiedBy = ModifiedBy;
                
                ShowCancelDialog = false;
                CancellationReason = string.Empty;
                
                await OnBookingUpdated.InvokeAsync(Booking);
                Snackbar.Add($"Booking for {Booking.FirstName} {Booking.LastName} has been cancelled", Severity.Warning);
                Logger.LogInformation("Booking {BookingId} cancelled successfully", Booking.Id);
            }
            else
            {
                Snackbar.Add("Failed to cancel booking. The booking may not be in a valid state for cancellation.", Severity.Error);
                Logger.LogWarning("Failed to cancel booking {BookingId} - service returned false", Booking.Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("An error occurred while cancelling the booking. Please try again.", Severity.Error);
            Logger.LogError(ex, "Failed to cancel booking {BookingId}", Booking.Id);
        }
        finally
        {
            IsOperationInProgress = false;
            _currentOperation = string.Empty;
            StateHasChanged();
        }
    }

    private async Task MarkAsCompleted()
    {
        try
        {
            IsOperationInProgress = true;
            _currentOperation = "complete";
            StateHasChanged();

            await BookingLoaderService.UpdateBookingStatusAsync(Booking.Id, BookingStatus.Completed, "Marked as completed", ModifiedBy);
            
            // Update the local booking object
            Booking.Status = BookingStatus.Completed;
            Booking.ModifiedAt = DateTime.UtcNow;
            Booking.ModifiedBy = ModifiedBy;
            
            await OnBookingUpdated.InvokeAsync(Booking);
            Snackbar.Add($"Booking for {Booking.FirstName} {Booking.LastName} has been marked as completed", Severity.Success);
            Logger.LogInformation("Booking {BookingId} marked as completed", Booking.Id);
        }
        catch (Exception ex)
        {
            Snackbar.Add("An error occurred while updating the booking status. Please try again.", Severity.Error);
            Logger.LogError(ex, "Failed to mark booking {BookingId} as completed", Booking.Id);
        }
        finally
        {
            IsOperationInProgress = false;
            _currentOperation = string.Empty;
            StateHasChanged();
        }
    }
}