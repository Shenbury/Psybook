@using Psybook.UI.Client.Services
@using Psybook.UI.Client.Components.Authentication
@inherits LayoutComponentBase
@inject IThemeService ThemeService
@inject NavigationManager Navigation
@implements IDisposable

<MudThemeProvider Theme="@ThemeService.CurrentTheme" IsDarkMode="@ThemeService.IsDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="2" Dense="false">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                       Color="Color.Inherit" 
                       Edge="Edge.Start" 
                       OnClick="ToggleDrawer" 
                       aria-label="Toggle navigation menu" />
        
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="ml-2">
            <MudIcon Icon="@Icons.Material.Filled.Pets" Color="Color.Inherit" />
            <MudText Typo="Typo.h6" Class="d-none d-sm-flex">
                WMSP Booking System
            </MudText>
            <MudText Typo="Typo.body1" Class="d-flex d-sm-none">
                WMSP
            </MudText>
        </MudStack>
        
        <MudSpacer />
        
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudTooltip Text="@GetThemeTooltip()" Placement="Placement.Bottom">
                <MudIconButton Icon="@GetThemeIcon()" 
                               Color="Color.Inherit" 
                               OnClick="ToggleTheme" />
            </MudTooltip>
            
            <!-- Authentication Display -->
            <LoginDisplay />
            
            <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                     Color="Color.Inherit" 
                     Dense="true"
                     AnchorOrigin="Origin.BottomRight">
                <MudMenuItem Icon="@Icons.Material.Filled.Home" 
                             OnClick="NavigateHome">
                    Home
                </MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.Add" 
                             OnClick="NavigateToBooking">
                    Book Experience
                </MudMenuItem>
                <MudDivider />
                <MudMenuItem Icon="@Icons.Material.Filled.Info" 
                             OnClick="ShowAbout">
                    About
                </MudMenuItem>
            </MudMenu>
        </MudStack>
    </MudAppBar>
    
    <MudDrawer @bind-Open="_drawerOpen" 
               ClipMode="DrawerClipMode.Always" 
               Elevation="3"
               Variant="@DrawerVariant.Mini">
        <div class="drawer-header pa-4">
            <MudStack AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Color="Color.Primary" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.Pets" />
                </MudAvatar>
                @if (_drawerOpen)
                {
                    <div class="text-center">
                        <MudText Typo="Typo.h6" Color="Color.Primary">WMSP</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Booking System</MudText>
                    </div>
                }
            </MudStack>
        </div>
        
        <MudDivider Class="mb-2" />
        
        <NavMenu />
        
        <MudSpacer />
        
        <!-- Footer in drawer -->
        <div class="drawer-footer pa-2">
            @if (_drawerOpen)
            {
                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                        West Midlands Safari Park
                    </MudText>
                    <MudText Typo="Typo.overline" Color="Color.Secondary" Align="Align.Center">
                        v1.0.0
                    </MudText>
                </MudStack>
            }
            else
            {
                <MudTooltip Text="West Midlands Safari Park v1.0.0" Placement="Placement.Right">
                    <MudIcon Icon="@Icons.Material.Filled.Copyright" 
                             Color="Color.Secondary" 
                             Size="Size.Small" 
                             Class="mx-auto d-block" />
                </MudTooltip>
            }
        </div>
    </MudDrawer>
    
    <MudMainContent>
        <div class="main-content pa-4">
            <MudContainer MaxWidth="MaxWidth.False" Class="pa-0">
                <AuthorizeView>
                    <Authorized>
                        @Body
                    </Authorized>
                    <NotAuthorized>
                        <div class="d-flex justify-center align-center" style="height: 60vh;">
                            <MudPaper Class="pa-8" Elevation="4" Width="450px">
                                <MudStack AlignItems="AlignItems.Center" Spacing="4">
                                    <MudIcon Icon="@Icons.Material.Filled.Badge" 
                                             Color="Color.Primary" 
                                             Size="Size.Large" />
                                    <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Primary">
                                        WMSP Employee Portal
                                    </MudText>
                                    <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary">
                                        Please sign in with your WMSP employee credentials to access the VIP booking 
                                        system and manage guest experiences.
                                    </MudText>
                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Primary" 
                                               Size="Size.Large"
                                               StartIcon="@Icons.Material.Filled.Login"
                                               OnClick="SignIn">
                                        Employee Sign In
                                    </MudButton>
                                    <MudDivider />
                                    <MudStack AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                                            Secure employee authentication powered by<br />
                                            West Midlands Safari Park Azure AD
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        </div>
                    </NotAuthorized>
                </AuthorizeView>
            </MudContainer>
        </div>
    </MudMainContent>
</MudLayout>

<!-- Error UI -->
<div id="blazor-error-ui" data-nosnippet>
    <MudPaper Class="pa-4 ma-4" Elevation="8">
        <MudStack AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" />
            <MudText Typo="Typo.h6" Color="Color.Error">An unhandled error has occurred</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                Something went wrong. Please reload the page or contact support if the problem persists.
            </MudText>
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="ReloadPage">
                    Reload
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Secondary" 
                           StartIcon="@Icons.Material.Filled.Close"
                           OnClick="DismissError">
                    Dismiss
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
</div>

@code {
    #region Fields and Properties
    private bool _drawerOpen = true;
    #endregion

    #region Lifecycle Methods
    protected override void OnInitialized()
    {
        base.OnInitialized();
        ThemeService.ThemeChanged += StateHasChanged;
        
        // Adjust drawer state based on screen size
        _drawerOpen = !IsMobileDevice();
    }
    #endregion

    #region Event Handlers
    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void ToggleTheme()
    {
        ThemeService.ToggleDarkMode();
    }

    private void NavigateHome()
    {
        Navigation.NavigateTo("/");
    }

    private void NavigateToBooking()
    {
        Navigation.NavigateTo("/book");
    }

    private void ShowAbout()
    {
        // Could show a dialog with app information
    }

    private async Task SignIn()
    {
        Navigation.NavigateTo("MicrosoftIdentity/Account/SignIn", forceLoad: true);
    }

    private void ReloadPage()
    {
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }

    private void DismissError()
    {
        // Hide the error UI element
    }
    #endregion

    #region Helper Methods
    private string GetThemeIcon()
    {
        return ThemeService.IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode;
    }

    private string GetThemeTooltip()
    {
        return ThemeService.IsDarkMode ? "Switch to light mode" : "Switch to dark mode";
    }

    private static bool IsMobileDevice()
    {
        // Simple heuristic - in a real app, you might use JS interop to detect screen size
        return false; // Default to desktop for now
    }
    #endregion

    #region IDisposable Implementation
    public void Dispose()
    {
        ThemeService.ThemeChanged -= StateHasChanged;
    }
    #endregion
}


